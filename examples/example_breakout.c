#include "prosystem.h"
#include "stdlib.h"
#include "string.h"
#include "armyfont.h"
#define MODE_320AC
#include "multisprite_8lines.h"

unsigned char X, Y;

// Generated from sprites7800 breakout.yaml
holeydma reversed scattered(8,6) char suitcase_even[48] = {
	0x30, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x71, 0xf5, 0xf5, 0xf5, 0xf5, 0xf4, 0x57, 0xbd, 0xf5, 0xf5,
	0xe5, 0xdd, 0x56, 0xb9, 0x59, 0xd6, 0x65, 0xd9, 0x53, 0xbd, 0x7a, 0xfa, 0x65, 0xdc, 0x30, 0xf0,
	0xf0, 0xf0, 0xf0, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
holeydma reversed scattered(8,6) char suitcase_odd[48] = {
	0x70, 0xf0, 0xf0, 0xf0, 0xf0, 0xc0, 0xf1, 0xf5, 0xf5, 0xf5, 0xf5, 0xe4, 0xb7, 0x75, 0xf5, 0xf5,
	0xd7, 0xad, 0xb6, 0x65, 0xb9, 0xa6, 0xd6, 0xa9, 0xb3, 0x65, 0xfa, 0xea, 0xd7, 0xac, 0x70, 0xf0,
	0xf0, 0xf0, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
holeydma reversed scattered(8,2) char ball_even[16] = {
	0x32, 0x88, 0x7a, 0xc8, 0xfa, 0xeb, 0xfa, 0xeb, 0xfa, 0xeb, 0x7e, 0xcc, 0x33, 0x8c, 0x00, 0x00
};
holeydma reversed scattered(8,2) char ball_odd[16] = {
	0x12, 0xc8, 0x32, 0xea, 0x7a, 0xfb, 0x7a, 0xfb, 0x7a, 0xfb, 0x32, 0xeb, 0x13, 0xcc, 0x00, 0x00
};
holeydma reversed scattered(8,2) char brick[16] = {
	0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x7f, 0xff, 0x00, 0x00
};
holeydma reversed scattered(8,1) char side_brick[8] = {
	0xdf, 0xdf, 0xdf, 0x00, 0xfb, 0xfb, 0xfb, 0x00
};

ramchip char pos_paddle;
ramchip char str[5];

void interrupt dli()
{
    *BACKGRND = 0x05;
    Y = 200;
    do {
        strobe(WSYNC); // 3 cycles
        if ((*INPT0 & 0x80)) break; // 7 cycles
        Y--;
    } while (Y); // Looping 5 cycles
    pos_paddle = Y;
    // This takes 15 cycles out of 113.5. Maria should have enough 
    *VBLANK = 0x80; // Dump paddles to ground
    *BACKGRND = 0x00;
}

void game_init()
{
    *P0C2 = multisprite_color(0x34);
    *P1C2 = multisprite_color(0x40);
    *P2C2 = multisprite_color(0x1c);
    *P3C2 = 0x0f;
}

void display_paddle()
{
    char x = pos_paddle;
    char x2 = x >> 1;
    char *gfx;
    if (x & 1) {
        gfx = suitcase_even;
    } else {
        gfx = suitcase_odd;
    }
    multisprite_display_sprite_aligned(x2, 192, gfx, 6, 0, 1);
}

void main()
{
    game_init();
    multisprite_init();
    multisprite_set_charbase(font);
    multisprite_enable_dli(0);
    multisprite_save();

    // Main loop
    do {

        while (!(*MSTAT & 0x80)); // Wait for VBLANK
        *BACKGRND = 0x0f;
        *VBLANK = 0x00; // Let paddle capacitors charging 
        
        // Display paddle position
        multisprite_restore();
        itoa(pos_paddle, str, 10);
        char len = strlen(str);
        multisprite_display_tiles(0, 1, str, len, 0);
        display_paddle();
        *BACKGRND = 0x00;

        // Wait for VBLANK to end
        while (*MSTAT & 0x80);
    } while(1);
}
