#include "conio.h"

scattered(8, 32) holeydma char full[8 * 32] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

void main()
{
    char i, y;
    clrscr();
    for (y = 0; y != 11; y++) {
        gotoxy(0, y);
        textcolor(y & 7);
        _ms_tmpptr = _ms_dls[X = _conio_y];
        Y = _ms_dlend[X];
        // Draw 3 grey bars, that consume (8 + 31 * 3) * 3 = 303 DMA cycles
        for (i = 0; i != 3; i++) {
            _ms_tmpptr[Y++] = full;
            _ms_tmpptr[Y++] = -31 & 0x1f;
            _ms_tmpptr[Y++] = full >> 8;
            _ms_tmpptr[Y++] = 0;
        }
        // Then draw y bars in Holey DMA, that theoretically consume 8 + penalty DMA cycles each
        for (i = 0; i != y; i++) {
            _ms_tmpptr[Y++] = 0x00;
            _ms_tmpptr[Y++] = -31;
            _ms_tmpptr[Y++] = 0x98;
            _ms_tmpptr[Y++] = 0;
        }
        // Then draw a colorful bar, that consumes 8 + (nb pixels actually drawn / 8) * 3 DMA cycles
        _ms_tmpptr[Y++] = full;
        _ms_tmpptr[Y++] = 0x40;
        _ms_tmpptr[Y++] = full >> 8;
        _ms_tmpptr[Y++] = _conio_palette;
        _ms_tmpptr[Y++] = 16;
        _ms_dlend[X] = Y++;
        _ms_tmpptr[Y] = 0;
    }
    while(1); 
}
